name: Validate PR Description

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate-pr-description:
    runs-on: ubuntu-latest
    steps:
    - name: Validate PR body content
      env:
        PR_BODY: ${{ github.event.pull_request.body }}
      run: |
        echo "Checking PR body for required content..."

        # Use a safer method for cleaning the body
        CLEANED_BODY=$(echo "$PR_BODY" | sed 's///g')
        
        # 1. Check if Summary section is filled
        # Use a non-greedy regex to prevent matching across multiple sections
        SUMMARY_CONTENT=$(echo "$CLEANED_BODY" | sed -n '/## ðŸ“Œ Summary/,/---/p' | sed '1d;$d' | tr -d '[:space:]')
        if [ -z "$SUMMARY_CONTENT" ]; then
          echo "Error: The 'Summary' section is empty."
          exit 1
        fi

        # 2. Check if at least one checkbox is checked
        CHECKED_BOXES=$(echo "$CLEANED_BODY" | grep -c '^- \[x\]')
        if [ "$CHECKED_BOXES" -lt 1 ]; then
          echo "Error: At least one checkbox under 'Changes' must be checked."
          exit 1
        fi

        # 3. Check if one description type is filled
        # Extract the Description section
        DESCRIPTION_SECTION=$(echo "$CLEANED_BODY" | sed -n '/## ðŸ“– Description/,//p')
        
        # Check if any of the sub-sections have content
        if ! echo "$DESCRIPTION_SECTION" | sed 's/###.*//' | grep -q '[[:alnum:]]'; then
            echo "Error: At least one of the 'New Features', 'Bug Fixes', or 'Documentation' sections must be filled."
            exit 1
        fi
        
        echo "PR template validation passed. All required sections are filled correctly."