name: Validate PR Description

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate-pr-description:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR body content
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "Checking PR body for required content..."

          # Remove HTML comments to not mistake them for content
          CLEANED_BODY=$(echo "$PR_BODY" | sed 's///g')

          # 1. Check if Summary section is filled
          SUMMARY_CONTENT=$(echo "$CLEANED_BODY" | awk '/## üìå Summary/,/---/' | sed '1d;$d' | tr -d '[:space:]')
          if [ -z "$SUMMARY_CONTENT" ]; then
            echo "Error: The 'Summary' section is empty."
            exit 1
          fi

          # 2. Check if at least one checkbox is checked
          CHECKED_BOXES=$(echo "$CLEANED_BODY" | grep '^- \[x\]' | wc -l)
          if [ "$CHECKED_BOXES" -lt 1 ]; then
            echo "Error: At least one checkbox under 'Changes' must be checked."
            exit 1
          fi

          # 3. Check if one description type is filled
          DESCRIPTION_CONTENT=$(echo "$CLEANED_BODY" | awk '/## üìñ Description/,//' | grep -E '### (‚ú® New Features|üêõ Bug Fixes|üìö Documentation)' -A 1)
          FILLED_DESCRIPTION=false
          if echo "$DESCRIPTION_CONTENT" | sed 's/.*: -//' | grep -v '^-'; then
            FILLED_DESCRIPTION=true
          fi
          if [ "$FILLED_DESCRIPTION" = "false" ]; then
            echo "Error: At least one of the 'New Features', 'Bug Fixes', or 'Documentation' sections must be filled."
            exit 1
          fi

          echo "PR template validation passed. All required sections are filled correctly."