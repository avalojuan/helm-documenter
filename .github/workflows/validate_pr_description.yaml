name: Validate PR Description

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate-pr-description:
    runs-on: ubuntu-latest
    steps:
    - name: Validate PR body content
      env:
        PR_BODY: ${{ github.event.pull_request.body }}
      run: |
        echo "Checking PR body for required content..."
        
        # 1. Check if Summary section is filled
        # Extract text between "## üìå Summary" and "---" and remove whitespace.
        SUMMARY_CONTENT=$(echo "$PR_BODY" | awk '/## üìå Summary/,/---/' | sed '1d;$d' | tr -d '[:space:]')
        if [ -z "$SUMMARY_CONTENT" ]; then
          echo "Error: The 'Summary' section is empty."
          exit 1
        else
          echo "Summary section is filled."
        fi

        echo "Checking for checked boxes in 'Changes' section..."

        # Grab section after "## üîß Changes"
        CHANGES_SECTION=$(echo "$PR_BODY" | grep -A20 "## üîß Changes")

        # Safety: ensure section is not empty
        if [ -z "$CHANGES_SECTION" ]; then
          echo "‚ùå Error: Could not find 'Changes' section in PR body"
          exit 1
        else
            echo "‚úÖ Changes section found."
        fi

        # Count checkboxes
        if ! echo "$CHANGES_SECTION" | grep -q '^- \[x\]'; then
          echo "‚ùå Error: No checkboxes found under 'Changes' section."
          exit 1
        else
          echo "‚úÖ At least one checkbox is checked."
        fi

        # 3. Check if one description type is filled
        # Extract the entire "Description" section
        DESCRIPTION_SECTION=$(echo "$PR_BODY" | sed -n '/## üìñ Description/,//p')

        # Check if any of the sub-sections have content.
        # 'sed' removes the sub-headers, and 'grep' checks for any alphanumeric characters.
        if ! echo "$DESCRIPTION_SECTION" | sed 's/###.*//' | grep -q '[[:alnum:]]'; then
          echo "Error: At least one of the 'New Features', 'Bug Fixes', or 'Documentation' sections must be filled."
          exit 1
        else
            echo "‚úÖ At least one description section is filled."
        fi

        echo "‚úÖ PR template validation passed. All required sections are filled correctly."